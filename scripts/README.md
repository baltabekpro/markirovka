# Документация системы обработки отчетов ЦРПТ

## Общее описание системы

Данная система предназначена для автоматизации процессов взаимодействия с API Центра развития перспективных технологий (ЦРПТ) в рамках национальной системы маркировки товаров "Честный знак". Система позволяет получать и обрабатывать отчеты о нарушениях маркировки, агрегировать данные по регионам и товарным группам, а также отправлять сводные отчеты по электронной почте уполномоченным лицам.

## Архитектура системы

Система построена по модульному принципу и состоит из следующих основных компонентов:

1. **Модуль авторизации и работы с токенами** - обеспечивает получение и управление токенами доступа к API ЦРПТ
2. **Модуль получения и обработки отчетов** - позволяет создавать задания на получение отчетов и обрабатывать результаты
3. **Модуль анализа нарушений** - анализирует данные и формирует сводную статистику по различным параметрам
4. **Модуль отправки уведомлений** - отправляет отчеты по электронной почте
5. **Планировщик задач** - обеспечивает автоматическое выполнение операций по расписанию
6. **Управление регионами** - позволяет группировать данные по региональным подразделениям
7. **Пользовательский интерфейс** - консольный интерфейс для взаимодействия с системой

## Описание основных модулей

### Модуль авторизации и работы с токенами

Файлы: `token_manager.py`, `token_utils.py`, `get_token.py`, `get_tokens.py`

Обеспечивает:
- Получение данных для подписи от сервера ЦРПТ
- Подписание данных с использованием КриптоПро CSP
- Получение и сохранение токенов доступа
- Управление множественными сертификатами и токенами
- Поддержка работы с сертификатами, имеющими множественные ИНН и ТС

### Модуль получения и обработки отчетов

Файлы: `get_violations.py`, `get_report.py`, `process_report.py`

Функциональность:
- Создание заданий на получение отчетов о нарушениях маркировки
- Мониторинг статуса выполнения заданий
- Загрузка готовых отчетов
- Обработка и парсинг CSV-файлов отчетов
- Преобразование данных в структурированный формат для дальнейшего анализа

### Модуль анализа нарушений

Файлы: `report_processor.py`, `aggregate_violations.py`

Возможности:
- Агрегация данных о нарушениях по товарным группам
- Агрегация данных по регионам
- Расчет статистики по типам нарушений
- Выявление наиболее проблемных регионов и товарных групп
- Формирование сводных JSON-отчетов

### Модуль отправки уведомлений

Файлы: `email_utils.py`, `send_daily_report.py`

Обеспечивает:
- Формирование HTML-писем с отчетами о нарушениях
- Отправка ежедневных отчетов по указанным адресам
- Группировка отчетов по регионам для адресной рассылки
- Настройка параметров отправки через конфигурационный файл

### Планировщик задач

Файлы: `scheduler.py`

Функциональность:
- Настройка расписания автоматического выполнения задач
- Ежедневный запуск обновления токенов
- Ежедневный запуск получения и обработки отчетов
- Работа в фоновом режиме без необходимости постоянного вмешательства пользователя

### Управление регионами

Файлы: `region_manager.py`, `regions.json`

Позволяет:
- Управлять списком регионов для группировки данных
- Назначать ответственных лиц для получения отчетов по регионам
- Редактировать параметры регионов через интерфейс программы

### Пользовательский интерфейс

Файлы: `main.py`, `file_viewer.py`, `file_utils.py`, `file_manager.py`

Обеспечивает:
- Удобное меню навигации по функциям системы
- Просмотр и редактирование файлов конфигурации
- Управление токенами и сертификатами
- Ручной запуск обработки отчетов
- Просмотр журналов работы программы
- Информативные цветные сообщения о статусе выполнения операций

## Настройка системы

### Требования к системе

- Windows 7/10/11
- Python 3.7+
- КриптоПро CSP (для работы с сертификатами)
- Доступ к Интернету для взаимодействия с API ЦРПТ

### Установка и настройка

1. **Установка Python и необходимых пакетов**:
   ```
   pip install requests colorama pandas
   ```

2. **Настройка КриптоПро CSP** - необходимо установить и настроить КриптоПро CSP для работы с сертификатами, импортированными от ЦРПТ.

3. **Настройка конфигурационных файлов**:
   - `certificates.json` - информация о сертификатах
   - `email_config.json` - настройки для отправки email
   - `regions.json` - настройка регионов
   - `true_api_tokens.json` - будет создан автоматически
   - `cert_inns.json` - настройка соответствий сертификатов и ИНН/ТС

4. **Первичная инициализация сертификатов**:
   - Используйте функцию установки сертификата из файлов
   - Настройте сопоставление сертификатов и ИНН/ТС

## Руководство пользователя

### Запуск программы

Для запуска программы используйте командную строку:
```
python main.py
```

Для запуска в режиме демона (планировщика):
```
python main.py --daemon
```

### Основное меню

Основное меню программы предоставляет следующие опции:
1. **Запустить ежедневную обработку** - ручной запуск полного цикла обработки отчетов
2. **Управление файлами** - просмотр и редактирование файлов системы
3. **Управление токенами и сертификатами** - настройка и управление сертификатами
4. **Просмотреть отчеты о нарушениях** - просмотр имеющихся отчетов
5. **Отправить отчет по email** - ручная отправка отчетов
6. **Обновить токены** - обновление токенов доступа
7. **Установить сертификат из файла** - импорт новых сертификатов
8. **Запустить планировщик** - запуск автоматического планировщика задач
9. **Управление регионами** - настройка региональных параметров
0. **Выход из программы**

#### Подробное описание пунктов меню

##### 1. Запустить ежедневную обработку
Этот пункт меню инициирует полный цикл обработки отчетов:
- Обновление токенов доступа
- Создание заданий на выгрузку отчетов о нарушениях маркировки
- Скачивание готовых отчетов
- Обработку и анализ данных
- Группировку отчетов по регионам
- Отправку сводных отчетов по электронной почте

При выборе этого пункта будут использоваться данные за вчерашний день, что позволяет получить наиболее актуальную информацию о нарушениях маркировки.

##### 2. Управление файлами
Подменю для работы с файлами системы:
- **Просмотр файлов и директорий** - навигация по файловой системе с возможностью просмотра файлов различных форматов (JSON, CSV, текстовые файлы, логи)
- **Текстовый редактор** - встроенный редактор для просмотра и редактирования текстовых файлов
- **Удалить файл или папку** - функция удаления ненужных файлов
- **Скопировать файл в другую директорию** - копирование файлов между директориями
- **Информация о следующем запуске** - отображение времени последнего и следующего автоматического запуска
- **Просмотр журналов работы** - просмотр логов работы системы с цветовым выделением уровней сообщений

##### 3. Управление токенами и сертификатами
Подменю для работы с сертификатами и токенами доступа:
- **Просмотр информации о сертификатах** - отображает список доступных сертификатов и их параметры
- **Просмотр токенов** - показывает список активных токенов и их срок действия
- **Добавить ТС-ИНН пару** - добавление связки ТС-ИНН для сертификатов с множественными организациями
- **Обновить токены для всех сертификатов** - принудительное обновление всех токенов доступа
- **Проверить работоспособность токенов** - тестирование токенов на валидность
- **Настройка сертификатов с множественными ИНН** - специальный режим для сертификатов, работающих с несколькими юридическими лицами

##### 4. Просмотреть отчеты о нарушениях
Позволяет просмотреть сохраненные отчеты о нарушениях:
1. Система отображает список доступных сертификатов
2. После выбора сертификата показывается список дат, за которые есть отчеты
3. Выбрав дату, пользователь получает детальную информацию о нарушениях:
   - Общее количество нарушений
   - Распределение по товарным группам
   - Графическое представление динамики нарушений (если доступно)

##### 5. Отправить отчет по email
Позволяет вручную отправить сохраненные отчеты по электронной почте:
1. Выбор сертификата из списка доступных
2. Выбор даты отчета
3. Выбор получателей из списка настроенных адресов или ввод нового адреса
4. Подтверждение отправки

##### 6. Обновить токены
Запускает процедуру обновления токенов доступа к API ЦРПТ:
- Получение данных для подписи с сервера авторизации
- Подписание данных с использованием сертификатов в хранилище КриптоПро
- Получение новых токенов доступа
- Сохранение токенов в файл для дальнейшего использования

Обновление выполняется для всех сертификатов, указанных в конфигурационном файле certificates.json.

##### 7. Установить сертификат из файла
Мастер установки нового сертификата:
1. Запрос пути к архиву с сертификатом (поддерживаются форматы RAR, ZIP)
2. Распаковка архива во временную директорию
3. Установка сертификата в хранилище КриптоПро с использованием утилиты certmgr.exe
4. Запрос информации о сертификате (имя, ИНН, признак множественности)
5. Добавление информации о сертификате в конфигурационный файл

##### 8. Запустить планировщик
Запускает автоматический планировщик задач в фоновом режиме:
- Планировщик будет выполнять задачи согласно расписанию, указанному в scheduler_config.json
- По умолчанию токены обновляются в 00:05, отчеты получаются в 01:00, email-уведомления отправляются в 08:00
- После запуска планировщика программа продолжит работу в обычном режиме, а планировщик будет действовать в фоне

##### 9. Управление регионами
Подменю для настройки региональной структуры:
- **Просмотр списка регионов** - отображение сохраненных регионов и их параметров
- **Добавить регион** - добавление нового региона с указанием наименования и контактного email
- **Редактировать регион** - изменение параметров существующего региона
- **Удалить регион** - удаление региона из списка
- **Назначить сертификаты региону** - привязка сертификатов к конкретному региону

##### 0. Выход из программы
Завершает работу программы. Если был запущен планировщик, он продолжит работать в фоновом режиме.

### Работа с сертификатами

1. **Установка сертификата**:
   - Выберите пункт "Установить сертификат из файла"
   - Укажите путь к RAR/ZIP архиву с сертификатом
   - Введите пароль (если требуется)
   - Система установит сертификат в хранилище КриптоПро

2. **Настройка множественных ИНН**:
   - Для сертификатов, работающих с несколькими организациями
   - Позволяет указать соответствие между ТС (точки системы) и ИНН

### Работа с отчетами

1. **Получение отчетов о нарушениях**:
   - Автоматически через планировщик (ежедневно)
   - Вручную через пункт "Запустить ежедневную обработку"

2. **Просмотр отчетов**:
   - Выберите пункт "Просмотреть отчеты о нарушениях"
   - Выберите сертификат из списка
   - Выберите дату отчета

3. **Отправка отчетов по email**:
   - Автоматически через планировщик
   - Вручную через пункт "Отправить отчет по email"

### Работа с файлами

Меню управления файлами позволяет:
1. Просматривать файлы и директории
2. Использовать встроенный текстовый редактор
3. Удалять файлы и папки
4. Копировать файлы
5. Просматривать информацию о следующем запуске
6. Просматривать журналы работы

## Управление регионами и ТС (торговыми системами)

### Общие принципы

Система позволяет группировать данные по регионам и ТС (торговым системам) для более эффективного управления и анализа. Для полноценной работы необходимо настроить:
1. Связь между сертификатами и ТС-ИНН
2. Распределение ТС по регионам
3. Назначение ответственных лиц для каждого региона

### Настройка связи сертификатов и ТС-ИНН

#### Где хранится информация

Связь между сертификатами и ТС-ИНН хранится в файле `cert_inns.json`. Структура файла:
```json
{
  "Имя сертификата 1": [
    {"ТС1": "ИНН1"},
    {"ТС2": "ИНН2"}
  ],
  "Имя сертификата 2": [
    {"ТС3": "ИНН3"},
    {"ТС4": "ИНН4"}
  ]
}
```

#### Как добавить ТС-ИНН для сертификата

1. **Через меню программы**:
   - В главном меню выберите "3. Управление токенами и сертификатами"
   - Выберите "Добавить ТС-ИНН пару"
   - Выберите сертификат из списка
   - Введите ТС и соответствующий ИНН

2. **Ручное редактирование файла**:
   - Откройте файл `cert_inns.json` в текстовом редакторе
   - Добавьте или измените соответствующие записи
   - Сохраните файл

#### Пример:

Если у вас есть сертификат "Иванов Иван" и вам нужно добавить ТС "тс42" с ИНН "7701234567":
```json
{
  "Иванов Иван": [
    {"тс42": "7701234567"}
  ]
}
```

### Управление регионами

#### Структура данных о регионах

Информация о регионах хранится в файле `regions.json`. Пример структуры:
```json
{
  "regions": [
    {
      "id": "siberia",
      "name": "Сибирский регион",
      "email": "siberia@company.com",
      "ts_list": ["тс54", "тс55", "тс142"]
    },
    {
      "id": "ural",
      "name": "Уральский регион",
      "email": "ural@company.com",
      "ts_list": ["тс66", "тс59", "тс74"]
    }
  ]
}
```

#### Создание и редактирование регионов

1. **Через меню программы**:
   - В главном меню выберите "9. Управление регионами"
   - Выберите соответствующий пункт для добавления или редактирования региона
   - Следуйте инструкциям на экране для ввода данных

2. **Пошаговый процесс добавления региона**:
   - Выберите "Добавить регион"
   - Введите идентификатор региона (например, "far_east")
   - Введите название региона (например, "Дальневосточный регион")
   - Введите email-адрес для отправки отчетов по региону
   - Выберите ТС, которые будут относиться к данному региону

### Привязка ТС к регионам

#### Метод 1: При создании/редактировании региона
1. Выберите "9. Управление регионами" в главном меню
2. Выберите "Редактировать регион" или "Добавить регион"
3. При добавлении ТС в регион, будет предложено выбрать из списка или ввести новые ТС

#### Метод 2: Через управление ТС
1. Выберите "9. Управление регионами" в главном меню
2. Выберите "Управление ТС в регионах"
3. Выберите ТС из списка для перемещения между регионами

### Типичные сценарии использования

#### Сценарий 1: Настройка новой ТС для сертификата
1. Получите информацию о новой ТС и её ИНН
2. В главном меню выберите "3. Управление токенами и сертификатами"
3. Выберите "Добавить ТС-ИНН пару"
4. Выберите соответствующий сертификат
5. Введите ТС и ИНН
6. Затем в главном меню выберите "9. Управление регионами"
7. Выберите "Назначить ТС региону"
8. Выберите нужный регион
9. Добавьте новую ТС в список ТС региона

#### Сценарий 2: Перемещение ТС между регионами
1. В главном меню выберите "9. Управление регионами"
2. Выберите "Управление ТС в регионах"
3. Выберите ТС из списка
4. Укажите новый регион для выбранной ТС

#### Сценарий 3: Настройка с нуля после установки
1. Установите все необходимые сертификаты через пункт "7. Установить сертификат из файла"
2. Для каждого сертификата добавьте ТС-ИНН пары через меню "3. Управление токенами и сертификатами"
3. Создайте необходимые регионы через меню "9. Управление регионами"
4. Распределите ТС по регионам через "9. Управление регионами" -> "Назначить ТС региону"
5. Настройте адреса электронной почты для каждого региона
6. Запустите планировщик через пункт "8. Запустить планировщик"

### Алгоритм работы с регионами и ТС

1. **Анализ структуры организации**:
   - Определите количество и названия регионов вашей компании
   - Составьте список всех ТС и их соответствующих ИНН
   - Определите, какие ТС относятся к каким регионам

2. **Настройка сертификатов**:
   - Установите все сертификаты в систему
   - Для каждого сертификата укажите ТС и ИНН, с которыми он работает

3. **Настройка регионов**:
   - Создайте все необходимые регионы
   - Для каждого региона укажите список ТС
   - Задайте email-адреса для получения отчетов по каждому региону

4. **Проверка настройки**:
   - Запустите пробную ежедневную обработку через пункт "1. Запустить ежедневную обработку"
   - Проверьте, что отчеты формируются и отправляются на указанные адреса
   - При необходимости скорректируйте настройки

### Примечания и рекомендации

1. **Уникальность ТС**: 
   - Каждая ТС должна иметь уникальный идентификатор
   - Не рекомендуется иметь одинаковые ТС для разных сертификатов

2. **Разделение по регионам**:
   - Одна ТС должна принадлежать только одному региону
   - При необходимости можно создавать подрегионы с более детальным разделением

3. **Резервное копирование**:
   - Регулярно создавайте резервную копию файлов `cert_inns.json` и `regions.json`
   - Это защитит от потери данных при сбоях или ошибках настройки

4. **Масштабирование**:
   - Система поддерживает неограниченное количество регионов и ТС
   - При большом количестве данных рекомендуется группировать регионы логически

## Технические детали

### Структура каталогов

- `/` - корневая директория с основными скриптами
- `/logs` - журналы работы программы
- `/output` - выходные данные и отчеты
- `/output/{certificate_name}` - данные для конкретного сертификата
- `/output/{certificate_name}/reports` - сохраненные отчеты о нарушениях

### Конфигурационные файлы

- `certificates.json` - информация о сертификатах
  ```json
  {
    "certificates": [
      {
        "name": "Название сертификата",
        "thumbprint": "отпечаток сертификата",
        "multi_inn": false
      }
    ]
  }
  ```

- `email_config.json` - настройки электронной почты
  ```json
  {
    "smtp_server": "smtp.example.com",
    "smtp_port": 587,
    "sender_email": "sender@example.com",
    "sender_password": "password",
    "recipient_emails": ["recipient@example.com"]
  }
  ```

- `regions.json` - настройка регионов
  ```json
  {
    "regions": [
      {
        "id": "region1",
        "name": "Название региона",
        "email": "region@example.com"
      }
    ]
  }
  ```

- `scheduler_config.json` - настройка планировщика задач
  ```json
  {
    "daily_refresh_time": "00:05",
    "daily_reports_time": "01:00",
    "send_emails_time": "08:00"
  }
  ```

### Логирование

Система использует модуль `logging` для ведения подробных журналов работы. Журналы хранятся в директории `/logs` и разделены по компонентам:
- `main.log` - общий журнал работы
- `tokens.log` - журнал операций с токенами
- `reports.log` - журнал операций с отчетами
- `email.log` - журнал отправки email
- `files.log` - журнал операций с файлами

### Обработка ошибок

Система имеет развитый механизм обработки ошибок:
- Подробное логирование всех ошибок
- Автоматические повторные попытки при сбоях сети
- Сохранение промежуточных результатов при прерывании процесса
- Информативные сообщения о проблемах для пользователя

## Плановые задачи

### Ежедневные операции

1. **Обновление токенов** - выполняется автоматически (обычно в 00:05)
2. **Получение отчетов о нарушениях** - выполняется автоматически (обычно в 01:00)
3. **Обработка и анализ отчетов** - выполняется сразу после получения
4. **Отправка уведомлений по email** - выполняется по расписанию (обычно в 08:00)

### Мониторинг выполнения

- Информация о последнем и следующем запуске хранится в `last_run.json`
- Детальные журналы операций доступны в директории `/logs`
- Статус планировщика можно проверить через меню программы

## Telegram Bot Integration

### Настройка Telegram бота

1. Создайте нового бота через @BotFather в Telegram
2. Получите токен бота
3. Заполните файл `telegram_config.json`:
   - `token`: Ваш токен бота
   - `allowed_users`: Массив ID пользователей, которым разрешен доступ к боту
   - `admin_users`: Массив ID пользователей с правами администратора
   - `error_notification_chat_ids`: Массив ID чатов для отправки уведомлений об ошибках

### Команды бота

- `/start` - Начать работу с ботом
- `/help` - Показать список команд
- `/status` - Проверить статус системы
- `/reports` - Показать доступные отчеты
- `/errors` - Показать последние ошибки
- `/restart` - Перезапустить планировщик заданий (только для администраторов)
- `/run` - Запустить ежедневную обработку (только для администраторов)
- `/tokens` - Проверить токены API

### Уведомления

Бот автоматически отправляет уведомления о:
- Критических ошибках в системе
- Успешном завершении ежедневной обработки
- Успешной отправке отчетов по электронной почте

### Как узнать свой Telegram ID

Отправьте сообщение боту @userinfobot, и он вернет ваш ID.

## Заключение

Система обработки отчетов ЦРПТ представляет собой комплексное решение для автоматизации работы с национальной системой маркировки товаров. Она позволяет значительно упростить процессы получения и анализа данных о нарушениях маркировки, обеспечивая своевременное информирование ответственных лиц и помогая в принятии управленческих решений.