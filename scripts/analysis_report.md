# Анализ проблемы с одинаковыми результатами для разных товарных групп

## Выявленные проблемы

На основе анализа кода и документации API ГИС МТ, обнаружены следующие возможные причины, по которым определенные товарные группы всегда имеют одинаковые результаты в отчетах о нарушениях:

1. **Объединение товарных групп при формировании отчета**: 
   API может объединять некоторые товарные группы или применять к ним одинаковые фильтры при формировании данных о нарушениях.

2. **Ошибки в обработке CSV-файлов**:
   Полученные от API бинарные CSV-файлы могут неправильно обрабатываться из-за проблем с кодировкой или форматом, 
   что приводит к искажению данных или повторению значений.

3. **Методология подсчета нарушений**:
   Для некоторых товарных групп может применяться одинаковая методология подсчета нарушений,
   особенно если они относятся к одной регуляторной категории.

4. **Проблемы с API-запросами**:
   Код в `get_violations.py` использует метод `/violations/first-date` и делает запрос к `/violations`,
   но не проверяет полноту или достоверность ответа от API.

5. **Распределение нарушений по умолчанию**:
   Если система не может определить фактическое количество нарушений для конкретной товарной группы,
   она может назначать некоторое значение по умолчанию.

## Рекомендации по решению

1. **Обновить код обработки ответов API**:
   Добавить более детальную валидацию и логирование ответов API, чтобы определить, 
   возвращает ли API одинаковые значения или проблема возникает при обработке данных.

2. **Улучшить конвертацию CSV-файлов**:
   Расширить функцию `try_read_csv_with_encodings` в `convert_reports.py` для лучшей обработки бинарных данных,
   проверки на дублирование и корректности формата.

3. **Проверить документацию API**:
   В документации API (раздел 8.7 PDF-документа) есть описание методов получения CSV-данных о нарушениях.
   Необходимо сверить использование этих методов с текущей реализацией.

4. **Отладочные сверки**:
   Добавить функционал для сравнения полученных данных с другими источниками информации для проверки достоверности.

5. **Обработка разных типов нарушений**:
   Убедиться, что для всех товарных групп правильно учитываются различные типы нарушений.

6. **Проверка структуры запроса**:
   Проверить, корректно ли передаются параметры фильтрации в методе `create_violations_task`
   для разных товарных групп.

## Исправления для системного решения

Для полного решения проблемы рекомендуется:

1. Добавить подробное логирование всех запросов и ответов API
2. Разработать функции валидации данных перед их анализом и суммированием
3. Создать механизм перепроверки подозрительно одинаковых результатов
4. Добавить визуализацию данных для более наглядного выявления аномалий
